import cv2
import socket
import struct
import pickle
import threading
import pyaudio

# --- CONFIGURATION ---
CLIENT_IP = "93.28.230.141"  # ðŸ”§ Remplace par lâ€™IP du client (rÃ©cepteur)
PORT = 9999

# --- Connexion socket ---
print(f"Tentative de connexion au client {CLIENT_IP}:{PORT}...")
client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client_socket.connect((CLIENT_IP, PORT))
print("ConnectÃ© au client âœ…")

# --- CamÃ©ra ---
cap = cv2.VideoCapture(0)

# --- Micro ---
CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 44100

p = pyaudio.PyAudio()
stream = p.open(format=FORMAT, channels=CHANNELS, rate=RATE, input=True, frames_per_buffer=CHUNK)

# --- Thread dâ€™envoi ---
def send_data():
    try:
        while True:
            # Envoi vidÃ©o
            ret, frame = cap.read()
            if not ret:
                continue
            data = pickle.dumps(frame)
            message = struct.pack("Q", len(data)) + data
            client_socket.sendall(b'V' + message)

            # Envoi audio
            audio_data = stream.read(CHUNK)
            audio_msg = struct.pack("H", len(audio_data)) + audio_data
            client_socket.sendall(b'A' + audio_msg)

    except Exception as e:
        print("Connexion perdue :", e)
        client_socket.close()

send_data()

